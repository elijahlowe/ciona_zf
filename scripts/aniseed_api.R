install.packages("httr")
install.packages("jsonlite")

library(httr)
library(jsonlite)

library(RCurl)
library("tidyverse")
library(dplyr)




get_api_genes <- function(cell){
  path <- "https://www.aniseed.cnrs.fr/api/all_genes_by_territory:?"
  request <- GET(url = path, 
                 query = list(
                   cell = cell,
                   organism_id = 464)
  )
  
  request$status_code
  response <- content(request, as = "text", encoding = "UTF-8")
  df <- fromJSON(response, flatten = TRUE) %>% 
    data.frame()
  as_tibble(df)
  df$genes[[1]] %>% as_tibble()
  
}

get_territories <- function(KH_id){
  #KH_id %>% as_tibble() %>% mutate(KH_id = gsub("\\.v.+", "", value))
  gene_names <- all_genes %>% dplyr::filter(gene_model == KH_id) %>% 
    dplyr::select(gene_name) %>% 
    mutate(gene_name = gsub("\\;.*","",gene_name))
  
  path <- "https://www.aniseed.cnrs.fr/api/all_territories_by_gene:?"
  request <- GET(url = path, 
                 query = list(
                   gene = gene_names,
                   organism_id = 464)
  )
  
  request$status_code
  response <- content(request, as = "text", encoding = "UTF-8")
  df <- fromJSON(response, flatten = TRUE) %>% 
    data.frame()
  as_tibble(df) %>% 
    mutate(KHid = KH_id)
}


scRNA <- c("KH.C11.737", "KH.L18.30", "KH.C1.832", "KH.C8.749", "KH.C13.35", "KH.L116.66", "KH.C10.317", "KH.C8.248", "KH.C7.77", "KH.C5.363", "KH.C3.21", "KH.L4.43", "KH.S391.1", "KH.L40.17", "KH.S164.13", "KH.C7.66", "KH.C8.891", "KH.L20.18", "KH.C11.328", "KH.C8.582", "KH.C7.633", "KH.C3.14", "KH.C6.164", "KH.L96.34", "KH.C12.31", "KH.S1735.4", "KH.C3.724", "KH.C2.33", "KH.L144.11", "KH.C5.124", "KH.C12.115", "KH.C12.600", "KH.C2.245", "KH.C5.217", "KH.C9.500", "KH.C9.97", "KH.C7.261", "KH.C1.669", "KH.C5.232", "KH.S1404.1", "KH.C2.313", "KH.C2.872", "KH.C8.751", "KH.C3.303", "KH.C11.313", "KH.C7.728", "KH.C10.448", "KH.C3.903", "KH.C13.116", "KH.C7.349", "KH.C9.549", "KH.L99.8", "KH.C3.640", "KH.S115.26", "KH.C3.225", "KH.C4.271", "KH.C1.1211", "KH.C4.411", "KH.C8.344", "KH.C3.567", "KH.C1.129", "KH.C12.39", "KH.C4.268", "KH.C12.687", "KH.C3.228", "KH.C2.667", "KH.C1.121", "KH.S417.6", "KH.L119.20", "KH.C8.135", "KH.C1.423", "KH.L96.87", "KH.L152.2", "KH.C12.309", "KH.C4.631", "KH.C2.378", "KH.C9.374", "KH.C8.503", "KH.L170.69", "KH.C4.370", "KH.C2.434", "KH.C11.44", "KH.C9.131", "KH.C3.753", "KH.C12.336", "KH.C4.554", "KH.C1.1281", "KH.L22.61", "KH.C12.244", "KH.C7.500", "KH.L22.57", "KH.C12.40", "KH.C9.485", "KH.C12.235", "KH.C7.62", "KH.C1.1220", "KH.C1.356", "KH.C9.78", "KH.C7.721", "KH.C4.747", "KH.C7.484", "KH.C3.883", "KH.C11.331", "KH.C11.144", "KH.C8.763", "KH.C2.739", "KH.C3.767", "KH.L37.39", "KH.S396.5", "KH.C6.76", "KH.C7.487", "KH.C4.624", "KH.L22.67", "KH.L116.50", "KH.C8.573", "KH.L170.97", "KH.L153.113", "KH.C3.77", "KH.S936.2", "KH.C2.169", "KH.C3.522", "KH.C3.63", "KH.L20.49", "KH.C12.104", "KH.C2.1123", "KH.C4.685", "KH.C12.662", "KH.C12.254", "KH.L141.65", "KH.C7.133", "KH.S461.1", "KH.C2.63", "KH.L129.5", "KH.L172.23", "KH.C9.336", "KH.L5.22", "KH.L96.3", "KH.C3.551", "KH.C3.699", "KH.S461.5", "KH.S115.4", "KH.C2.866", "KH.C3.815", "KH.C5.355", "KH.C2.209", "KH.C1.335", "KH.S164.11", "KH.C3.830", "KH.L99.11", "KH.C8.467", "KH.L37.5", "KH.C13.79", "KH.L96.15", "KH.C12.72", "KH.C11.456", "KH.C9.28", "KH.C4.7", "KH.C9.698", "KH.L94.3", "KH.C12.11", "KH.C11.2", "KH.C13.46", "KH.C10.566", "KH.C8.77", "KH.C12.487", "KH.C4.116", "KH.C14.495", "KH.L4.22", "KH.C8.820", "KH.C9.891", "KH.C9.672", "KH.L71.19", "KH.C2.422", "KH.C1.777", "KH.C1.1224", "KH.C14.85", "KH.L94.2", "KH.C7.206", "KH.C11.210", "KH.C11.461", "KH.S762.3", "KH.C11.211", "KH.C4.17", "KH.L106.13", "KH.C8.355", "KH.C11.697", "KH.C9.778", "KH.C7.447", "KH.C12.129", "KH.C4.230", "KH.C7.42", "KH.C8.509", "KH.C4.394", "KH.C7.260", "KH.C2.137", "KH.L13.2", "KH.C2.208", "KH.C8.603", "KH.C11.143", "KH.C3.585", "KH.C14.188", "KH.C10.286", "KH.C7.238", "KH.C1.571", "KH.L9.20", "KH.C5.572", "KH.C1.322", "KH.S597.3", "KH.S1247.2", "KH.C11.354", "KH.S494.2", "KH.C4.64", "KH.C5.110", "KH.L37.15", "KH.S511.3", "KH.L73.3", "KH.C8.144", "KH.S852.4", "KH.L153.55", "KH.L97.11", "KH.L153.65", "KH.C12.7", "KH.C12.217", "KH.L149.21", "KH.C7.461", "KH.C9.187", "KH.C9.558", "KH.C9.234", "KH.C13.110", "KH.C1.216", "KH.C11.310", "KH.L13.3", "KH.L44.13", "KH.C4.265", "KH.C1.683", "KH.C11.89", "KH.L141.31", "KH.C2.792", "KH.C14.398", "KH.C10.250", "KH.L156.3", "KH.S643.6", "KH.C9.422", "KH.C9.260", "KH.C7.63", "KH.C2.591", "KH.C7.479", "KH.C4.799", "KH.C7.128", "KH.C14.553", "KH.L65.27", "KH.C2.810", "KH.C6.163", "KH.L155.12", "KH.L37.59", "KH.L153.32", "KH.L58.5", "KH.C1.738", "KH.L106.6", "KH.C9.24", "KH.S655.2", "KH.C14.181", "KH.C13.152", "KH.C13.53", "KH.C1.448", "KH.C4.262", "KH.L37.63", "KH.C2.187", "KH.C10.78", "KH.C10.470", "KH.C2.596", "KH.L140.5", "KH.C6.155", "KH.C8.197", "KH.C5.322", "KH.C2.420", "KH.C2.549", "KH.C12.13", "KH.C1.244", "KH.C6.167", "KH.L170.42", "KH.L40.4", "KH.C10.382", "KH.C2.593", "KH.L116.49", "KH.C8.552", "KH.L57.5", "KH.C2.668", "KH.S447.2", "KH.C14.220", "KH.C14.575", "KH.C1.196", "KH.C14.395", "KH.C7.18", "KH.S679.4", "KH.C11.386", "KH.C1.146", "KH.C3.124", "KH.C12.612", "KH.C8.316", "KH.C10.169", "KH.C2.34", "KH.L154.44", "KH.C4.111", "KH.L170.96", "KH.L96.32", "KH.L44.2", "KH.L4.23", "KH.C11.49", "KH.C11.378", "KH.C1.98", "KH.C11.429", "KH.C13.73", "KH.L141.10", "KH.L173.2", "KH.C3.871", "KH.C5.348", "KH.C11.167", "KH.C5.362", "KH.C2.562", "KH.C1.21", "KH.C11.680", "KH.C4.213", "KH.L3.10", "KH.C2.171", "KH.C9.199", "KH.C2.220", "KH.C9.745", "KH.S568.2", "KH.S164.24", "KH.C14.354", "KH.L173.9", "KH.C12.472", "KH.L155.23", "KH.C7.167", "KH.C4.193", "KH.L102.8", "KH.C3.358", "KH.L37.3", "KH.C8.241", "KH.L6.3", "KH.C2.36", "KH.C5.495", "KH.C4.391", "KH.L108.6", "KH.C5.547", "KH.C5.588", "KH.C2.312", "KH.C9.180", "KH.C14.329", "KH.S534.4", "KH.C9.197", "KH.C12.356", "KH.L154.31", "KH.C8.508", "KH.L34.17", "KH.L96.16", "KH.C10.624", "KH.L22.15", "KH.L24.7", "KH.C2.828", "KH.C1.1257", "KH.C9.717", "KH.S735.2", "KH.L141.1", "KH.C4.603", "KH.C1.174", "KH.C8.126", "KH.S406.14", "KH.C14.48", "KH.C10.205", "KH.C4.168", "KH.L60.2", "KH.L37.33", "KH.L130.1", "KH.C4.173", "KH.L13.35", "KH.L108.1", "KH.C7.188", "KH.C7.40", "KH.S800.2", "KH.C3.45", "KH.C3.453", "KH.C11.214", "KH.C2.620", "KH.C7.703", "KH.C8.293", "KH.C1.726", "KH.L13.5", "KH.C12.317", "KH.C11.314", "KH.C2.994", "KH.C2.750", "KH.C7.107", "KH.C7.214", "KH.C9.538", "KH.C8.696", "KH.C3.59", "KH.C10.267", "KH.C11.568", "KH.C9.725", "KH.C14.227", "KH.C3.133", "KH.C2.166", "KH.C14.88", "KH.C9.243", "KH.C4.226", "KH.L157.5", "KH.C11.655", "KH.C9.613", "KH.C1.661", "KH.C7.702", "KH.C10.347", "KH.C3.855", "KH.C8.540", "KH.C1.101", "KH.L53.14")
scRNA <- c("KH.C1.346", "KH.L57.9", "KH.C11.531", "KH.C11.61", "KH.C5.183", "KH.L133.7", "KH.C2.327", "KH.C5.12", "KH.C1.81", "KH.C10.119", "KH.C7.618", "KH.S521.4", "KH.C2.97", "KH.L11.2", "KH.C12.174", "KH.S605.4", "KH.L4.17", "KH.L38.2", "KH.S403.4", "KH.C2.387", "KH.L5.19", "KH.C8.836", "KH.L71.2", "KH.C9.582", "KH.C3.174", "KH.C5.134", "KH.C3.451", "KH.C5.385", "KH.C1.237", "KH.L116.70", "KH.C8.778", "KH.C4.81", "KH.C9.35", "KH.C7.190", "KH.C2.22", "KH.L18.108", "KH.L13.17", "KH.L22.56", "KH.C2.374", "KH.C3.545", "KH.C4.516", "KH.S595.11", "KH.C4.326", "KH.C4.231", "KH.C14.12", "KH.C12.84", "KH.C1.611", "KH.C2.696", "KH.C12.381", "KH.C3.154", "KH.C4.177", "KH.C5.30", "KH.C4.529", "KH.L22.45", "KH.C2.925", "KH.C9.347", "KH.C11.252", "KH.C7.269", "KH.C7.198", "KH.C11.184", "KH.L41.62", "KH.C9.650", "KH.C5.281", "KH.C5.78", "KH.L95.5", "KH.C3.676", "KH.C3.825", "KH.C9.501", "KH.L108.20", "KH.C1.1093", "KH.L48.1", "KH.C1.646", "KH.C1.40", "KH.C8.64", "KH.C4.767", "KH.C7.724", "ENSCING00000025226", "KH.L106.19", "KH.C14.356", "KH.C9.189", "KH.L141.8", "KH.C11.690", "KH.L34.14", "KH.C8.164", "KH.L4.3", "KH.C4.319", "KH.C8.877", "KH.C7.452", "KH.L119.34", "KH.C5.25", "KH.L34.8", "KH.C1.819", "KH.C4.90", "KH.L34.7", "KH.C1.252", "KH.S406.9", "KH.C1.188", "KH.C8.122", "KH.C1.525", "KH.C2.929", "KH.C14.16", "KH.C1.1104", "KH.L17.11", "KH.C1.183", "KH.L61.5", "KH.C7.521", "KH.C4.470", "KH.C12.587", "KH.S164.28", "KH.C8.494", "KH.C9.3", "KH.C6.113", "KH.L108.30", "KH.L145.2", "KH.C1.1000", "KH.L63.2", "KH.C14.446", "KH.C2.919", "KH.C2.406", "KH.S1337.3", "KH.C4.544", "KH.C9.494", "KH.C9.204", "KH.C9.162", "KH.C14.371", "KH.L13.24", "KH.L149.22", "KH.C4.410", "KH.S437.6", "KH.C9.701", "KH.C11.458", "KH.C5.240", "ENSCING00000025210", "KH.C3.261", "KH.C5.83", "KH.C1.1240", "KH.C3.905", "KH.C10.101", "KH.C2.893", "KH.L57.18", "KH.S406.15", "KH.C5.537", "KH.L96.44", "KH.L8.1", "KH.C4.444", "KH.C9.30", "KH.C7.230", "KH.C8.244", "KH.C9.656", "KH.L5.14", "KH.C10.360", "KH.C3.223", "KH.C12.229", "KH.C14.361", "KH.L132.5", "KH.L54.2", "KH.S351.4", "KH.L170.16", "KH.C8.510", "KH.C4.201", "KH.C5.52", "KH.C3.204", "KH.C1.1109", "KH.C9.434", "KH.C3.578", "KH.C11.199", "KH.C2.425", "KH.C14.535", "KH.S1352.1", "KH.C7.154", "KH.C12.343", "ENSCING00000025213", "KH.C4.146", "KH.L63.13", "KH.C7.106", "KH.C1.329", "KH.C14.201", "KH.C7.281", "KH.C14.154", "KH.C12.118", "ENSCING00000025204", "KH.C13.52", "KH.C4.335", "KH.C10.434", "KH.C8.609", "KH.C2.609", "KH.L169.2", "KH.C8.686", "KH.C10.350", "KH.C1.621", "KH.L101.1", "KH.C2.248", "KH.L23.5", "KH.C1.870", "KH.C4.401", "KH.C8.121", "KH.L108.10", "KH.C3.114", "KH.C9.559", "KH.C8.70", "KH.C1.143", "KH.S1524.1", "KH.C14.414", "KH.C1.442", "KH.S417.3", "KH.C9.445", "KH.S423.2", "KH.C10.220", "KH.C14.166", "KH.C3.885", "KH.C3.298", "KH.S1391.2", "KH.C9.859", "KH.C6.133", "KH.C12.537", "KH.C1.384", "KH.C4.253", "ENSCING00000025215", "KH.C11.299", "KH.C13.119", "KH.C2.826", "KH.C8.455", "KH.C2.251", "KH.C12.433", "KH.L108.49", "KH.C3.116", "KH.C2.364", "KH.C1.1074", "KH.C1.650", "KH.C9.432", "KH.S483.2", "KH.C3.149", "KH.C8.441", "KH.C11.628", "KH.C2.958", "KH.L18.85", "KH.C13.173", "KH.C3.74", "KH.C1.212", "KH.L164.4", "KH.C6.94", "KH.C9.157", "KH.L96.108", "KH.L92.8", "KH.C13.184", "KH.C8.182", "KH.L106.15", "KH.C9.161", "KH.C5.531")#, "KH.C8.1", "KH.L65.6", "KH.C9.331", "KH.C5.333", "KH.C9.20", "KH.C4.726", "KH.C5.44", "KH.C12.238", "KH.C5.394", "KH.C8.844", "KH.C1.57", "KH.C1.837", "KH.S1754.3", "KH.C5.118", "KH.C12.382", "KH.L154.60", "KH.C7.501", "KH.L132.16", "KH.C9.369", "KH.C5.422", "KH.C1.309", "KH.C3.503", "KH.C7.164", "KH.L170.71", "KH.C11.334", "KH.C8.67", "KH.C8.188", "KH.L96.19", "KH.L70.5", "KH.C2.492", "KH.C1.531", "KH.C11.681", "KH.S115.10", "KH.C11.215", "KH.C7.95", "KH.C1.465", "KH.L37.12", "KH.C1.428", "KH.C7.110", "KH.C3.394", "KH.C4.129", "KH.C3.305", "KH.C10.209", "KH.C1.73", "KH.S1391.3", "KH.C5.208", "KH.S1011.2", "KH.C8.459", "ENSCING00000025206", "KH.L18.22", "KH.C1.363", "KH.L4.8", "KH.C7.157", "KH.C11.643", "KH.C11.394", "KH.S803.3", "KH.C9.572", "KH.L122.10", "KH.C7.152", "KH.C8.446", "KH.C1.504", "KH.C8.350", "KH.C14.476", "KH.C2.131", "KH.C10.144", "KH.S1641.1", "KH.C10.241", "KH.C14.178", "KH.L20.55", "KH.L131.7", "KH.C7.58", "KH.S1641.2", "KH.C11.5", "KH.C1.1046", "KH.C14.549", "KH.C3.383", "KH.C13.193", "KH.C11.222", "KH.C7.784", "KH.L95.3", "KH.L130.11", "KH.C3.928", "KH.C4.317", "KH.S657.3", "KH.C1.26", "KH.L36.8", "KH.C9.160", "KH.L116.19", "KH.S164.12", "KH.C2.716", "KH.C7.288", "KH.L65.21", "KH.C2.694", "KH.C1.508", "KH.C1.303", "KH.C14.236", "KH.C1.865", "KH.L116.100", "KH.C13.106", "KH.S389.1", "KH.C8.147", "KH.C1.200", "KH.C1.821", "KH.C3.750", "KH.C5.265", "KH.C1.90", "KH.S346.11", "KH.C2.1006", "KH.L19.6", "KH.C9.740", "KH.L131.13", "KH.C14.117", "KH.C10.229", "KH.C2.787", "KH.C14.56", "KH.L121.2", "KH.C12.54", "KH.C7.253", "KH.C3.148", "KH.C10.65", "KH.C3.655", "KH.C1.1065", "KH.C8.136", "KH.C1.911", "KH.C4.420", "KH.L61.10", "KH.L166.4", "KH.S1107.2", "KH.C2.947", "KH.C12.576", "KH.C2.229", "KH.C11.293", "KH.C5.580", "KH.C8.565", "KH.C7.38", "KH.C12.185", "KH.C1.153", "KH.C4.316", "KH.C9.72", "KH.L34.27", "KH.C10.37", "KH.L65.28", "KH.C3.509", "KH.C8.845", "KH.C8.80", "KH.C1.1064", "KH.L95.18", "KH.L116.41", "ENSCING00000025218", "KH.C1.980", "KH.C7.82", "KH.C2.380", "KH.C9.709", "KH.C9.132", "KH.L172.9", "KH.C2.974", "KH.C11.729", "KH.L18.103", "KH.L18.18", "KH.C4.549", "KH.C1.618", "KH.C1.4", "KH.C1.603", "KH.C3.461", "KH.C7.211", "KH.C10.1", "KH.C3.673", "ENSCING00000025191", "KH.C4.609", "KH.C10.135", "KH.L87.5", "KH.C12.568", "KH.S2820.2", "KH.C8.523", "KH.C7.425", "KH.C5.285", "KH.C10.7", "ENSCING00000025201", "KH.C1.292", "KH.C5.323", "KH.C9.307", "KH.L152.18", "KH.L51.6", "KH.L22.40", "KH.L116.7", "KH.C11.408", "KH.L116.85", "KH.C13.57", "KH.L168.6", "KH.L116.22", "KH.C1.836", "KH.C1.1297", "KH.S916.1", "KH.C12.283", "KH.L154.5", "KH.C7.693", "KH.L164.15", "KH.C8.317", "KH.C6.160", "KH.C9.147", "KH.C1.306", "KH.L18.117", "KH.C1.889", "KH.S345.1", "KH.C14.492", "KH.C10.271", "KH.C6.58", "KH.L7.16", "KH.S511.1", "KH.C8.447", "KH.S1366.1", "KH.L18.107", "KH.C2.101", "KH.L50.21", "KH.C4.188", "KH.S988.1", "KH.C1.175", "KH.C8.223", "KH.C14.153", "KH.C8.118", "KH.L73.2", "KH.C6.26", "KH.C14.609", "KH.C5.250", "KH.C1.834", "KH.C6.291", "KH.C2.579", "KH.C8.737", "KH.C10.379", "KH.C2.247", "KH.C12.276", "KH.C10.403", "KH.L57.24", "KH.C8.395", "KH.C11.266", "KH.C4.547", "KH.S164.31", "KH.C1.670", "KH.S1176.1", "KH.C2.637", "KH.L17.10", "KH.C12.63", "KH.C1.336", "KH.C8.38", "KH.S390.1", "KH.C3.79", "KH.C14.464", "KH.C4.480", "KH.C11.254", "KH.C9.424", "KH.C4.364", "KH.C8.170", "KH.L173.5", "KH.C3.696", "KH.C8.270", "KH.L129.7", "KH.L154.56", "KH.C1.358", "KH.C9.271", "KH.C5.534", "KH.C1.665", "KH.C12.323", "KH.C1.173", "KH.C1.612", "KH.L96.91", "KH.L116.68", "KH.C2.358", "KH.L7.5", "KH.C1.299", "KH.C12.279", "KH.C7.309", "KH.C5.13", "KH.L9.27", "KH.C8.334", "KH.C14.278", "KH.C14.184", "KH.C14.474", "KH.S484.3", "KH.C7.560", "KH.C1.158", "KH.C8.201", "KH.C10.174", "KH.C13.36", "KH.C10.372", "KH.C11.241", "KH.C12.403", "KH.C12.180", "KH.C5.369", "KH.C9.517", "KH.C9.313", "KH.S498.1", "KH.C8.519", "KH.L57.32", "KH.C11.243", "KH.C2.1060", "KH.C2.594", "KH.C14.273", "KH.C12.677", "KH.L22.1", "KH.L124.11", "KH.C11.188", "KH.C3.598", "KH.C1.96", "KH.S1540.1", "KH.C11.22", "KH.C2.202", "KH.C6.239", "KH.C11.129", "KH.C9.527", "KH.L87.20", "KH.C10.512", "KH.C4.71", "KH.C5.21", "KH.C13.7", "KH.S406.8", "KH.C1.495", "KH.C5.247", "KH.C8.24", "KH.S2579.1", "KH.C14.293", "KH.C10.54", "KH.C10.45", "KH.L147.34", "KH.C1.182", "KH.C8.262", "KH.L141.32", "KH.C12.143", "KH.L63.22", "KH.C1.145", "KH.C7.4", "KH.C1.294", "KH.L27.2", "KH.C3.511", "KH.C12.304", "KH.C11.118", "KH.C8.13", "KH.C8.644", "KH.C2.112", "KH.S621.4", "KH.C5.269", "KH.S1754.1", "KH.C3.754", "KH.C1.11", "KH.C2.565", "KH.S902.3", "KH.C2.30", "KH.L61.14", "KH.C7.217", "KH.C12.544", "KH.C1.1032", "KH.C9.251", "KH.C6.174", "KH.S1721.1", "KH.C3.658", "KH.C2.46", "KH.L37.7", "KH.C9.491", "KH.L170.47", "KH.S256.16", "KH.C2.15", "KH.C7.535", "KH.C4.190", "KH.L96.47", "KH.C14.52", "KH.L135.4", "KH.C4.513", "KH.C11.700", "KH.C1.86", "KH.C13.55", "KH.C14.36", "KH.C10.558", "KH.C3.267", "KH.C4.339", "KH.C1.1013", "KH.C4.159", "KH.C11.522", "KH.C7.90", "KH.C1.914", "KH.S546.3", "KH.C2.453", "KH.C10.99", "KH.C1.412", "KH.C2.895", "KH.C8.475", "KH.C3.297", "KH.C1.429", "KH.S489.1", "KH.L150.1", "KH.C11.720", "KH.L130.10", "KH.C3.320", "KH.C2.490", "KH.C1.93", "KH.C8.374", "KH.L172.6", "KH.L116.23", "KH.C1.53", "KH.L114.13", "KH.L18.118", "KH.C6.2", "KH.C3.512", "KH.S573.2", "KH.L172.31", "KH.L116.16", "KH.L153.24", "KH.C4.261", "KH.C1.1252", "KH.S390.3", "KH.C10.170", "KH.L51.1", "KH.C2.802", "KH.C7.449", "KH.L149.1", "KH.C7.109", "KH.C14.86", "KH.L142.3", "KH.L153.88", "KH.L170.24", "KH.C2.78", "KH.C14.279", "KH.C2.286", "KH.C5.27", "KH.S1214.2", "KH.C10.202", "KH.C7.583", "KH.C12.408", "KH.C5.127", "KH.L64.4", "KH.S1155.2", "KH.L124.15", "KH.C4.354", "KH.C1.968", "ENSCING00000025220", "KH.S597.1", "KH.L108.18", "KH.C1.1099", "KH.C8.690", "KH.L170.11", "KH.C7.542", "KH.C3.781", "KH.C4.805", "KH.C7.763", "KH.C3.432", "KH.C9.226", "KH.C8.114", "KH.L9.4", "KH.C3.591", "KH.C12.49", "KH.C14.193", "KH.L141.53", "KH.C7.354", "KH.C2.550", "KH.C7.219", "KH.C7.271", "KH.L168.1", "KH.L114.3", "KH.L96.70", "KH.C14.435", "KH.C8.506", "KH.C2.740", "KH.S725.1", "KH.C14.504", "KH.C4.338", "KH.C2.321", "KH.C5.384", "KH.C8.400", "KH.C12.376", "KH.S460.5", "KH.S555.1", "KH.C4.365", "KH.C3.376", "KH.C4.157", "KH.C12.628", "KH.C1.675", "KH.C9.543", "KH.C9.583", "KH.L152.19", "KH.C1.764", "KH.C9.574", "KH.C5.221", "KH.S389.10", "KH.L96.35", "KH.S1914.1", "KH.L141.6", "KH.C3.19", "KH.C14.190", "KH.C10.459", "KH.C6.12", "KH.L79.1", "KH.C3.323", "KH.L171.5", "KH.L141.59", "KH.C8.71", "KH.C5.330", "KH.C3.746", "KH.C1.747", "KH.C2.271", "KH.C1.181", "KH.C2.1000", "KH.L69.5", "KH.C1.345", "KH.C5.616", "KH.C4.699", "KH.L153.20", "KH.C7.692", "KH.C5.227", "KH.C3.330", "KH.C12.419", "KH.C13.88", "KH.C5.191", "KH.C14.61", "KH.C7.495", "KH.C1.88", "KH.C14.330", "KH.C5.61", "KH.S406.3", "KH.C3.197", "KH.C9.662", "KH.C8.338", "KH.L19.3", "KH.C14.425", "KH.C11.490", "ENSCING00000025193", "KH.C1.835", "KH.C3.179", "KH.S346.6", "KH.C4.736", "KH.S389.4", "KH.C3.327", "KH.C3.525", "KH.C2.57", "KH.C1.25", "KH.C4.25", "KH.C4.506", "KH.C14.405", "KH.C11.483", "KH.L5.10", "KH.L170.67", "KH.C7.526", "KH.C4.479", "KH.L116.6", "KH.C7.116", "KH.C3.192", "KH.C5.587", "KH.C14.423", "KH.C11.583", "KH.C5.235", "KH.C5.382", "KH.C9.62", "KH.C2.960", "KH.C11.297", "KH.C4.758", "KH.C3.892", "KH.C9.786", "KH.C4.84", "KH.C4.152", "KH.C2.655", "KH.L71.9", "KH.C2.541", "KH.C2.612", "KH.C2.904", "KH.C14.191", "KH.C2.797", "KH.C9.700", "KH.L141.30", "KH.L84.15", "KH.C1.930", "KH.L65.32", "KH.C11.88", "KH.C2.505", "KH.S460.2", "KH.S437.4", "KH.L22.44", "KH.C10.506", "KH.S1482.2", "KH.C3.719", "KH.C8.554", "KH.C10.46", "KH.C13.87", "KH.C1.33", "KH.L154.46", "KH.C14.215", "KH.L4.21", "KH.C9.621", "KH.C3.742", "KH.C13.77", "KH.C6.206", "KH.C5.398", "KH.C6.128", "KH.C14.479", "KH.C3.745", "KH.C8.176", "KH.C7.30", "KH.C3.137", "KH.C11.489", "KH.C3.54", "KH.C9.561", "KH.C9.209", "KH.C8.660", "KH.C10.447", "KH.C8.100", "KH.C11.567", "KH.C14.282", "KH.C3.139", "KH.L116.61", "KH.C13.163", "KH.C13.3", "KH.L9.1", "KH.C14.18", "KH.C5.58", "KH.L120.1", "KH.C9.381", "KH.L96.46", "KH.C14.109", "KH.C5.467", "KH.C1.788", "KH.C9.541", "KH.C9.317", "KH.C14.76", "KH.L93.6", "KH.C9.1", "KH.C14.594", "KH.C9.203", "KH.L131.17", "KH.C3.690", "KH.C14.176", "KH.C7.361", "KH.C9.103", "KH.C8.43", "KH.C7.221", "KH.C9.790", "KH.L65.11", "KH.C1.1216", "KH.C12.630", "KH.L107.2", "KH.C8.755", "KH.L18.113", "KH.C6.99", "KH.C4.39", "KH.C1.598", "KH.C2.846", "KH.C9.636", "KH.S594.2", "KH.C14.4", "KH.C1.663", "KH.C7.391", "KH.S1925.1", "KH.C8.209", "KH.C14.46", "KH.C2.521", "KH.C12.92", "KH.C4.342", "KH.C2.191", "KH.C7.356", "KH.C4.306", "KH.C14.345", "KH.L171.6", "KH.L96.75", "KH.C11.645", "KH.L139.10", "KH.C8.771", "KH.C7.400", "KH.S852.2", "KH.C9.705", "KH.S621.1", "KH.C8.44", "KH.L133.9", "KH.C9.402", "KH.C5.10", "KH.C12.194", "KH.C7.96", "KH.C14.75", "KH.C12.372", "KH.C5.190", "ENSCING00000025212", "KH.C9.803", "KH.C5.50", "KH.C12.190", "KH.C4.22", "KH.L170.61", "KH.S403.8", "KH.C4.408", "KH.C7.426", "KH.L102.7", "KH.C1.483", "KH.C11.428", "KH.L7.2", "KH.L130.9", "KH.C3.927", "KH.C5.519", "KH.C3.103", "KH.L18.94", "KH.C9.403", "KH.C9.2", "KH.C8.450", "KH.L5.8", "KH.C7.419", "KH.C4.750", "KH.C4.94", "KH.C3.860", "KH.C7.774", "KH.C4.496", "KH.L116.10", "KH.L50.11", "KH.C6.145", "ENSCING00000025228", "KH.C7.210", "KH.C10.474", "KH.S595.8", "KH.C8.40", "KH.C1.1102", "KH.C8.174", "KH.C3.239", "KH.C7.473", "KH.L139.7", "KH.C1.287", "KH.C1.27", "KH.C8.387", "KH.L76.5", "KH.C2.852", "KH.S776.1", "KH.C14.531", "KH.C14.182", "KH.C2.369", "KH.C4.383", "KH.C14.179", "KH.C1.843", "KH.C12.418", "KH.L3.13", "KH.L119.17", "KH.C8.695", "KH.C4.363", "KH.C5.7", "KH.C14.250", "KH.C3.437", "KH.C9.206", "KH.C4.172", "KH.S534.10", "KH.C7.730", "KH.C10.187", "KH.C1.394", "KH.C1.259", "KH.C3.800", "KH.L164.5", "KH.L112.28", "KH.C3.30", "KH.C2.26", "KH.C9.138", "KH.C14.211", "KH.S435.8", "KH.L132.14", "KH.L149.18", "KH.C2.839", "KH.C1.757", "KH.C8.222", "KH.C12.603", "KH.C2.44", "KH.C9.334", "KH.C8.605", "KH.C11.218", "KH.C7.264", "KH.C12.21", "KH.C8.232", "KH.C11.202", "KH.C14.401", "KH.C2.688", "KH.L153.36", "KH.C2.421", "KH.C7.677", "KH.C11.615", "KH.C7.486", "KH.C9.511", "KH.C3.624", "KH.C2.546", "KH.C5.373", "KH.C10.140", "KH.C2.899", "KH.C1.433", "KH.C2.51", "KH.C3.211", "KH.L124.21", "KH.C4.137", "KH.L96.106", "KH.C11.112", "KH.C5.273", "KH.C4.293", "KH.C1.484", "KH.C4.771", "KH.C4.512", "KH.L131.5", "KH.C3.502", "KH.C8.177", "KH.L153.13", "KH.C3.526", "KH.C12.138", "KH.L5.2", "KH.L75.3", "KH.L96.2", "KH.C12.20", "KH.C5.3", "KH.C2.712", "KH.C11.479", "KH.C8.489", "KH.C1.1178", "KH.C6.186", "KH.C4.199", "KH.C3.744", "KH.C7.478", "KH.S1354.2", "KH.C8.724", "KH.L18.15", "KH.C2.506", "KH.C9.254", "KH.C13.74", "KH.L147.38", "KH.C2.884", "KH.C9.695", "KH.S1765.1", "KH.C9.579", "KH.L37.65", "KH.C14.411", "KH.C14.463", "KH.C5.138", "KH.C1.809", "KH.L20.63", "KH.C2.10", "KH.C8.404", "KH.C9.787", "KH.L20.29", "KH.S406.5", "KH.L5.20", "KH.S1251.1", "KH.C2.523", "KH.C4.163", "KH.C14.344", "KH.C12.465", "KH.C8.823", "KH.C3.797", "KH.C11.561", "KH.L24.23", "KH.C10.92", "KH.L106.9", "KH.C6.296", "KH.S435.5", "KH.C9.774", "KH.C6.115", "KH.C4.387", "KH.L119.19", "KH.L161.3", "KH.S621.8", "KH.C1.599", "KH.C4.114", "KH.L116.14", "KH.L149.28", "KH.C7.325", "KH.C1.814", "KH.C5.198", "KH.C7.581", "KH.C8.215", "KH.C2.335", "KH.C8.813", "KH.L119.1", "KH.C3.143", "KH.C10.242", "KH.C9.224", "KH.S854.4", "KH.L10.25", "KH.C11.159", "KH.C3.650", "KH.C9.239", "KH.C6.1", "KH.C7.392", "KH.C1.29", "KH.C1.410", "KH.C5.65", "KH.L161.5", "KH.S1090.4", "KH.C9.64", "KH.C4.464", "KH.C1.975", "KH.C1.996", "KH.C1.861", "KH.C8.793", "KH.C11.39", "KH.C8.328", "KH.C1.150", "KH.C9.551", "KH.L70.1", "KH.L147.3", "KH.C6.13", "KH.C11.527", "KH.C3.213", "KH.C2.151", "KH.C8.32", "KH.C1.494", "KH.C2.778", "KH.C7.649", "KH.C8.273", "KH.C9.888", "KH.C1.539", "KH.S389.6", "KH.C1.708", "KH.L22.64", "KH.C11.620", "KH.C8.633", "KH.C2.821", "KH.C8.401", "KH.C1.171", "KH.S437.3", "KH.C2.16", "KH.C2.606", "KH.S665.3", "KH.C10.33", "KH.C11.291", "KH.C8.41", "KH.C4.784", "KH.L153.101", "KH.C6.140", "KH.L112.7", "KH.C8.2", "KH.C9.284", "KH.C6.39", "KH.C3.476", "KH.C13.127", "KH.C10.283", "KH.C7.140", "KH.C3.296", "KH.C11.392", "KH.C4.88", "KH.C2.272", "KH.C2.728", "KH.C12.513", "KH.C8.72", "KH.C8.651", "KH.C12.439", "KH.L13.9", "KH.C2.494", "KH.L117.1", "KH.C9.135", "KH.C3.408", "KH.C14.225", "KH.C5.142", "KH.L149.13", "KH.C11.115", "KH.C3.193", "KH.C8.464", "KH.C4.9", "KH.C10.100", "KH.C13.27", "KH.C8.913", "KH.C2.1125", "KH.C7.662", "KH.L116.27", "KH.S164.8", "KH.S404.11", "KH.C6.282", "KH.L22.46", "KH.L75.12", "KH.C7.463", "KH.C11.434", "KH.C4.147", "KH.C14.428", "KH.C1.233", "KH.C8.192", "KH.C14.38", "KH.C2.198", "KH.C12.281", "KH.C7.277", "KH.C6.67", "KH.C8.199", "KH.L40.6", "KH.C8.792", "KH.C6.132", "KH.C8.242", "KH.C3.604", "KH.C3.134", "KH.C3.10", "KH.C5.24", "KH.C5.192", "KH.C5.60", "KH.L18.47", "KH.C8.627", "KH.C2.499", "KH.L17.4", "KH.L96.27", "KH.C7.320", "KH.C4.49", "KH.C10.111", "KH.C9.263", "KH.C5.219", "KH.C3.329", "KH.C2.473", "KH.C4.577", "KH.C5.397", "KH.C2.227", "KH.C1.289", "KH.C2.903", "KH.C4.46", "KH.C5.193", "KH.C14.65", "KH.C4.250", "KH.C4.237", "KH.C5.215", "KH.S544.1", "KH.C5.342", "KH.C2.827", "KH.S455.7", "KH.S696.5", "KH.C6.41", "KH.C1.30", "KH.C8.116", "KH.C3.378", "KH.C14.408", "KH.C14.96", "KH.C1.606", "KH.L37.28", "KH.C9.124", "KH.L87.11", "KH.L96.112", "KH.L38.10", "KH.L3.19", "KH.C4.120", "KH.L116.36", "KH.C3.888", "KH.L18.140", "KH.C2.511", "KH.C4.135", "KH.C8.548", "KH.C8.125", "KH.C7.582", "KH.C3.533", "KH.C1.550", "KH.C11.148", "KH.C6.304", "KH.C4.753", "KH.C7.279", "KH.C14.21", "KH.C8.892", "KH.C1.19", "KH.C3.643", "KH.C10.494", "KH.C2.659", "KH.L128.11", "KH.L141.45", "KH.C1.609", "KH.C1.1022", "KH.C2.90", "KH.C6.283", "KH.C8.405", "KH.C4.523", "KH.C8.480", "KH.C1.1016", "KH.C9.406", "KH.C1.186", "KH.C1.159", "KH.C9.42", "KH.S655.3", "KH.C3.304", "KH.C1.365", "KH.L155.9", "KH.L108.4", "KH.C1.439", "KH.C1.1186", "KH.C4.318", "KH.C7.805", "KH.C4.182", "KH.L170.14", "KH.C1.190", "KH.C1.20", "KH.C6.234", "KH.C4.52", "KH.C4.57", "KH.C1.520", "KH.C1.242", "KH.C4.343", "KH.C8.477", "KH.C8.859")
scRNA <- c("KH.C11.737", "KH.L18.30", "KH.C1.832", "KH.C8.749", "KH.C13.35", "KH.L116.66", "KH.C10.317", "KH.C8.248", "KH.C7.77", "KH.C5.363", "KH.C3.21", "KH.L4.43", "KH.S391.1", "KH.L40.17", "KH.S164.13", "KH.C7.66", "KH.C8.891", "KH.L20.18", "KH.C11.328", "KH.C8.582", "KH.C7.633", "KH.C3.14", "KH.C6.164", "KH.L96.34", "KH.C12.31", "KH.S1735.4", "KH.C3.724", "KH.C2.33", "KH.L144.11", "KH.C5.124", "KH.C12.115", "KH.C12.600", "KH.C2.245", "KH.C5.217", "KH.C9.500", "KH.C9.97", "KH.C7.261", "KH.C1.669", "KH.C5.232", "KH.S1404.1", "KH.C2.313", "KH.C2.872", "KH.C8.751", "KH.C3.303", "KH.C11.313", "KH.C7.728", "KH.C10.448", "KH.C3.903", "KH.C13.116", "KH.C7.349", "KH.C9.549", "KH.L99.8", "KH.C3.640", "KH.S115.26", "KH.C3.225", "KH.C4.271", "KH.C1.1211", "KH.C4.411", "KH.C8.344", "KH.C3.567", "KH.C1.129", "KH.C12.39", "KH.C4.268", "KH.C12.687", "KH.C3.228", "KH.C2.667", "KH.C1.121", "KH.S417.6", "KH.L119.20", "KH.C8.135", "KH.C1.423", "KH.L96.87", "KH.L152.2", "KH.C12.309", "KH.C4.631", "KH.C2.378", "KH.C9.374", "KH.C8.503", "KH.L170.69", "KH.C4.370", "KH.C2.434", "KH.C11.44", "KH.C9.131", "KH.C3.753", "KH.C12.336", "KH.C4.554", "KH.C1.1281", "KH.L22.61", "KH.C12.244", "KH.C7.500", "KH.L22.57", "KH.C12.40", "KH.C9.485", "KH.C12.235", "KH.C7.62", "KH.C1.1220", "KH.C1.356", "KH.C9.78", "KH.C7.721", "KH.C4.747", "KH.C7.484", "KH.C3.883", "KH.C11.331", "KH.C11.144", "KH.C8.763", "KH.C2.739", "KH.C3.767", "KH.L37.39", "KH.S396.5", "KH.C6.76", "KH.C7.487", "KH.C4.624", "KH.L22.67", "KH.L116.50", "KH.C8.573", "KH.L170.97", "KH.L153.113", "KH.C3.77", "KH.S936.2", "KH.C2.169", "KH.C3.522", "KH.C3.63", "KH.L20.49", "KH.C12.104", "KH.C2.1123", "KH.C4.685", "KH.C12.662", "KH.C12.254", "KH.L141.65", "KH.C7.133", "KH.S461.1", "KH.C2.63")

test_KHid <- test_KHid %>% as_tibble() %>% mutate(test_KHid = gsub("\\.v.+", "", value))
test_territories <- lapply(hold$geneName, get_territories)
scRNA_133_territories <- lapply(scRNA_133, get_territories)
test_territories_counts <- map(test_territories, 1) %>% base::unlist() %>% as_tibble() %>% 
  mutate(value = strsplit(as.character(value), ",")) %>% 
  unnest(value) %>% 
   group_by(value) %>% 
   count(value) %>% View()

ggplot(test_territories_counts, aes(x=value, fill = value)) + geom_bar() + theme_minimal()

test_territories_ <- test_territories %>% {
  tibble(
    anatomical_territory = map(., "anatomical_territory"),
    stage = map(., "stage")
  )
}

scRNA_133_territories %>% {
  tibble(
    KHid = map(., "KHid"),
    anatomical_territory = map(., "anatomical_territory"),
    stage = map(., "stage")
  )
} -> scRNA_territories_

scRNA_territories_ %>% unnest(cols = c(anatomical_territory, stage)) %>% 
  filter(stage == "Stage 14" & stage == "Stage 15") %>% 
  mutate(anatomical_territory = strsplit(as.character(anatomical_territory), ",")) %>% 
  unnest(anatomical_territory) %>%
  group_by(anatomical_territory) %>% 
  count() %>%
  ggplot(aes(x=reorder(anatomical_territory, n), y = n, fill = anatomical_territory)) + 
  geom_bar(stat = "identity") + theme_minimal()+coord_flip() + theme(legend.position='none')
